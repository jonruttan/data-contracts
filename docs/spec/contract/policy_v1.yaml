version: 1
title: Spec Runner Portable Contract Policy
rules:
  - id: CLI_RUN_ENTRYPOINT_REQUIRED
    introduced_in: v1
    scope: case
    applies_to: cli.run.harness.entrypoint
    norm: SHOULD
    requirement: prefer_present
    description: For cli.run, harness.entrypoint should be set in each case.
    rationale: Keeps invocation explicit and reduces environment coupling.
    risk_if_violated: Cases can become environment-dependent outside conformance.
    references:
      - docs/spec/contract/04_harness.md
      - docs/spec/schema/schema_v1.md

  - id: CLI_RUN_SAFE_MODE_RESTRICTS_HOOKS_AND_FALLBACK
    introduced_in: v1
    scope: implementation
    applies_to: cli.run.safe_mode
    norm: SHOULD
    requirement: disable_hooks_and_env_fallback_when_safe_mode_enabled
    description: >
      Implementations should provide a safe mode that disables hook entrypoints
      and entrypoint env fallback for `cli.run`.
    rationale: Reduces code-execution risk for hardened or semi-trusted workflows.
    risk_if_violated: Untrusted or mixed-trust specs have higher exploitability.
    references:
      - docs/spec/contract/04_harness.md
      - docs/spec/schema/schema_v1.md
      - docs/spec/impl/python.md

  - id: CLI_RUN_ENV_ALLOWLIST_CONTROL
    introduced_in: v1
    scope: implementation
    applies_to: cli.run.process_environment
    norm: SHOULD
    requirement: support_allowlist_for_inherited_environment
    description: >
      Implementations should provide a control to limit inherited process
      environment variables passed to cli.run executions.
    rationale: Limits accidental secret exposure from ambient CI/dev shells.
    risk_if_violated: Commands under test can read unrelated sensitive env.
    references:
      - docs/spec/contract/04_harness.md
      - docs/spec/schema/schema_v1.md
      - docs/spec/impl/php.md

  - id: CLI_RUN_ENTRYPOINT_ENV_FALLBACK
    introduced_in: v1
    scope: implementation
    applies_to: cli.run.entrypoint_resolution
    norm: SHOULD
    requirement: support_env_fallback_when_process_env_and_dynamic_entrypoint_loading_are_available
    description: >
      Implementations should support environment fallback for local/CI
      ergonomics when they can read process environment variables and resolve
      dynamic module:attribute entrypoints at runtime.
    rationale: Improves ergonomics in local and containerized workflows.
    risk_if_violated: Higher setup friction in some environments.
    examples:
      - SPEC_RUNNER_ENTRYPOINT
    references:
      - docs/spec/contract/04_harness.md
      - docs/spec/impl/python.md

  - id: CLI_RUN_CONFORMANCE_EXPLICIT_ENTRYPOINT
    introduced_in: v1
    scope: conformance
    applies_to: fixtures.cli.run
    norm: MUST
    requirement: explicit_harness_entrypoint
    description: Portable conformance fixtures must set harness.entrypoint.
    rationale: Keeps parity checks independent of implementation conveniences.
    risk_if_violated: Conformance results can diverge across runtimes.
    references:
      - docs/spec/contract/04_harness.md
      - docs/spec/contract/06_conformance.md

  - id: CLI_RUN_CONFORMANCE_NO_ENV_DEPENDENCY
    introduced_in: v1
    scope: conformance
    applies_to: fixtures.cli.run
    norm: MUST_NOT
    requirement: rely_on_env_fallback
    description: Portable conformance fixtures must not depend on env fallback.
    rationale: Prevents ambient-environment coupling in parity tests.
    risk_if_violated: Flaky or non-reproducible cross-language conformance.
    references:
      - docs/spec/contract/04_harness.md
      - docs/spec/contract/06_conformance.md

  - id: ASSERT_HEALTH_MODE_VALID_VALUES
    introduced_in: v1
    scope: case
    applies_to: assert_health.mode
    norm: MUST
    requirement: accept_only_ignore_warn_error
    description: >
      When assert_health.mode is provided, only ignore, warn, or error are
      valid values.
    rationale: Keeps diagnostics policy deterministic and portable.
    risk_if_violated: Implementations diverge on policy interpretation.
    references:
      - docs/spec/contract/02_case_shape.md
      - docs/spec/schema/schema_v1.md

  - id: ASSERT_HEALTH_GLOBAL_AND_PER_CASE_POLICY
    introduced_in: v1
    scope: implementation
    applies_to: assertion_health.policy_resolution
    norm: SHOULD
    requirement: support_global_default_and_per_case_override
    description: >
      Implementations should support both a global default policy and a
      per-case override for assertion-health diagnostics.
    rationale: Enables gradual rollout and targeted strictness.
    risk_if_violated: Hard to adopt diagnostics without broad breakage.
    references:
      - docs/spec/contract/00_design_goals.md
      - docs/spec/contract/02_case_shape.md

  - id: ASSERT_HEALTH_REDUNDANT_BRANCH_DIAGNOSTIC
    introduced_in: v1
    scope: case
    applies_to: assert.tree.group_children
    norm: SHOULD
    requirement: detect_redundant_sibling_branches
    description: >
      Implementations should diagnose redundant sibling assertion branches
      within a group (`must`, `can`, `cannot`) and surface them via
      assertion-health policy modes.
    rationale: Redundant branches hide intent and create maintenance noise.
    risk_if_violated: Specs can pass while carrying misleading duplicate logic.
    references:
      - docs/spec/contract/00_design_goals.md
      - docs/spec/contract/03_assertions.md
      - docs/spec/contract/03a_regex_portability_v1.md
      - docs/spec/schema/schema_v1.md

  - id: ASSERT_HEALTH_NON_PORTABLE_REGEX_DIAGNOSTIC
    introduced_in: v1
    scope: case
    applies_to: assert.tree.regex
    norm: SHOULD
    requirement: detect_non_portable_regex_constructs
    description: >
      Implementations should diagnose regex patterns that use non-portable
      constructs and surface them via assertion-health policy modes.
    rationale: Preserves cross-language determinism and reduces portability drift.
    risk_if_violated: Specs may pass in one runtime and fail in another.
    references:
      - docs/spec/contract/00_design_goals.md
      - docs/spec/contract/03_assertions.md
      - docs/spec/schema/schema_v1.md

  - id: SPEC_LANG_EVALUATE_LIST_SHAPE
    introduced_in: v1
    scope: case
    applies_to: assert.tree.evaluate
    norm: MUST
    requirement: evaluate_values_use_yaml_list_s_expressions
    description: >
      `evaluate` assertion values must use YAML list S-expression encoding.
    rationale: Keeps parsing deterministic and implementation-independent.
    risk_if_violated: Runtimes may interpret expressions inconsistently.
    references:
      - docs/spec/contract/03_assertions.md
      - docs/spec/contract/03b_spec_lang_v1.md
      - docs/spec/schema/schema_v1.md

  - id: SPEC_LANG_PREFERRED_AUTHORING
    introduced_in: v1
    scope: conformance
    applies_to: fixtures.assert.tree
    norm: SHOULD
    requirement: prefer_evaluate_spec_lang_for_new_assertions
    description: >
      Conformance fixtures should prefer `evaluate` (spec-lang) assertions as
      the primary authoring form. Non-`evaluate` leaf operators may remain only
      where explicitly allowlisted during migration.
    rationale: Keeps spec intent implementation-independent and reduces operator drift.
    risk_if_violated: Assertion semantics split across ad-hoc leaf operators and diverge across runtimes.
    references:
      - docs/spec/contract/03_assertions.md
      - docs/spec/contract/07_portable_spec_authoring.md
      - docs/spec/conformance/style.md

  - id: SPEC_LANG_PURE_EVALUATOR
    introduced_in: v1
    scope: implementation
    applies_to: assert.tree.evaluate.evaluator
    norm: MUST
    requirement: evaluator_is_pure_and_deterministic
    description: >
      The spec-lang evaluator must be pure and deterministic with no ambient
      side effects.
    rationale: Preserves cross-runtime parity and reproducibility.
    risk_if_violated: Expression outcomes can drift by environment/runtime.
    references:
      - docs/spec/contract/03b_spec_lang_v1.md
      - docs/spec/contract/06_conformance.md

  - id: SPEC_LANG_PROPER_TCO_REQUIRED
    introduced_in: v1
    scope: implementation
    applies_to: assert.tree.evaluate.recursion
    norm: MUST
    requirement: proper_tail_call_optimization_for_tail_position_calls
    description: >
      Implementations must provide proper tail-call optimization for
      tail-position `call` expressions.
    rationale: Avoids host-stack-dependent failures in portable recursive specs.
    risk_if_violated: Tail-recursive cases can fail by recursion depth.
    references:
      - docs/spec/contract/03b_spec_lang_v1.md
      - docs/spec/conformance/cases/spec_lang.spec.md

  - id: SPEC_LANG_EVAL_BUDGETS_REQUIRED
    introduced_in: v1
    scope: implementation
    applies_to: assert.tree.evaluate.budgets
    norm: MUST
    requirement: enforce_steps_nodes_literal_and_optional_timeout_budgets
    description: >
      Evaluators must enforce steps, nodes, literal-size, and optional timeout
      budgets for expression execution.
    rationale: Provides deterministic failure bounds for recursive expressions.
    risk_if_violated: Unbounded expression execution can hang or exhaust resources.
    references:
      - docs/spec/contract/03b_spec_lang_v1.md
      - docs/spec/schema/schema_v1.md

  - id: SPEC_LANG_ERROR_CLASSIFICATION
    introduced_in: v1
    scope: implementation
    applies_to: assert.tree.evaluate.errors
    norm: MUST
    requirement: classify_schema_assertion_runtime_errors_consistently
    description: >
      Spec-lang expression failures must map to schema/assertion/runtime
      categories consistently across implementations.
    rationale: Keeps conformance outcome contracts portable and debuggable.
    risk_if_violated: Same failing case reports different categories by runtime.
    references:
      - docs/spec/contract/03b_spec_lang_v1.md
      - docs/spec/contract/05_errors.md
      - docs/spec/schema/schema_v1.md

  - id: DOC_NORMATIVE_PAGE_TRACEABILITY
    introduced_in: v1
    scope: governance
    applies_to: docs.spec.contract.normative_pages
    norm: MUST
    requirement: every_normative_contract_page_has_traceability_coverage
    description: >
      Every normative contract page must be covered by at least one
      traceability contract_ref entry.
    rationale: Prevents contract pages from drifting stale without governance signal.
    risk_if_violated: Normative docs can silently diverge from enforced behavior.
    references:
      - docs/spec/contract/README.md
      - docs/spec/contract/traceability_v1.yaml

  - id: DOC_REGEX_PROFILE_LINKAGE
    introduced_in: v1
    scope: governance
    applies_to: docs.spec.regex_portability_profile
    norm: MUST
    requirement: regex_portability_profile_linked_in_assertions_schema_and_policy
    description: >
      The regex portability profile doc must be explicitly referenced by the
      assertion contract, schema, and policy.
    rationale: Keeps portability constraints visible at all normative layers.
    risk_if_violated: Portability guidance can be orphaned and ignored by implementers.
    references:
      - docs/spec/contract/03_assertions.md
      - docs/spec/contract/03a_regex_portability_v1.md
      - docs/spec/schema/schema_v1.md
      - docs/spec/contract/policy_v1.yaml

  - id: DOC_ASSERTION_OPERATOR_DOC_SYNC
    introduced_in: v1
    scope: governance
    applies_to: docs.spec.assertion_operators
    norm: MUST
    requirement: core_assertion_operator_tokens_synced_between_contract_and_schema
    description: >
      Core assertion operator names must remain synchronized between assertion
      contract docs and schema docs.
    rationale: Prevents stale naming drift between reader-oriented and schema docs.
    risk_if_violated: Users and implementers follow conflicting operator names.
    references:
      - docs/spec/contract/03_assertions.md
      - docs/spec/schema/schema_v1.md

  - id: CONFORMANCE_EXPECT_OVERLAY_RESOLUTION
    introduced_in: v1
    scope: conformance
    applies_to: fixtures.expect
    norm: MUST
    requirement: resolve_expectations_portable_then_impl_overlay
    description: >
      When conformance cases define inline expect metadata, implementations must
      resolve expected outcomes by starting from expect.portable and then
      overlaying expect.impl.<implementation> keys.
    rationale: Keeps portable intent primary while allowing explicit runtime deltas.
    risk_if_violated: Implementations drift on expectation resolution semantics.
    references:
      - docs/spec/contract/06_conformance.md
      - docs/spec/schema/schema_v1.md

  - id: CONFORMANCE_CASE_STYLE_GUARD
    introduced_in: v1
    scope: governance
    applies_to: fixtures.conformance.cases_style
    norm: MUST
    requirement: enforce_conformance_case_authoring_style
    description: >
      Conformance case docs must follow readability/style constraints enforced
      by governance checks (one case per block, heading alignment, sorted ids,
      bounded block size).
    rationale: Keeps conformance specs readable and reviewable as the corpus grows.
    risk_if_violated: Fixture docs become noisy and brittle to maintain.
    references:
      - docs/spec/conformance/style.md
      - docs/spec/contract/06_conformance.md

  - id: CONFORMANCE_REQUIRES_CAPABILITIES_POLICY
    introduced_in: v1
    scope: conformance
    applies_to: fixtures.requires.capabilities
    norm: MUST
    requirement: honor_requires_capabilities_and_when_missing_policy
    description: >
      Implementations must evaluate requires.capabilities and apply
      when_missing policy (`skip` or `fail`) deterministically.
    rationale: Keeps feature-gated conformance behavior portable and explicit.
    risk_if_violated: Capability-dependent cases drift across implementations.
    references:
      - docs/spec/contract/06_conformance.md
      - docs/spec/schema/schema_v1.md
      - docs/spec/conformance/report_format.md

  - id: PORTABLE_SPEC_CANONICAL_SINGLE_SET
    introduced_in: v1
    scope: conformance
    applies_to: fixtures.portable.canonical_set
    norm: MUST
    requirement: use_docs_spec_conformance_cases_as_portable_behavior_source
    description: >
      Portable, implementation-independent behavior coverage must live in the
      canonical conformance case set under docs/spec/conformance/cases.
    rationale: Keeps one executable source of truth across implementations.
    risk_if_violated: Spec behavior drifts across duplicated fixture sets.
    references:
      - docs/spec/contract/06_conformance.md
      - docs/spec/contract/07_portable_spec_authoring.md
      - docs/spec/conformance/README.md

  - id: PORTABLE_SPEC_EXPECT_PORTABLE_IMPL_OVERLAY
    introduced_in: v1
    scope: conformance
    applies_to: fixtures.expect_shape
    norm: MUST
    requirement: portable_baseline_with_runtime_overlays_only
    description: >
      Portable expectations must be defined in expect.portable; runtime deltas
      must be represented only via expect.impl.<runtime> overlays.
    rationale: Preserves a single portable baseline while allowing explicit deltas.
    risk_if_violated: Runtime-specific forks become implicit and hard to audit.
    references:
      - docs/spec/contract/06_conformance.md
      - docs/spec/contract/07_portable_spec_authoring.md
      - docs/spec/schema/schema_v1.md

  - id: PORTABLE_SPEC_DETERMINISM_BY_CONSTRUCTION
    introduced_in: v1
    scope: conformance
    applies_to: fixtures.portable.determinism
    norm: SHOULD
    requirement: avoid_ambient_time_random_network_and_undeclared_env
    description: >
      Portable conformance cases should be deterministic by construction and
      avoid ambient dependencies (time, randomness, network, undeclared env).
    rationale: Determinism is required for stable cross-runtime parity.
    risk_if_violated: Flaky parity and implementation-specific false negatives.
    references:
      - docs/spec/contract/06_conformance.md
      - docs/spec/contract/07_portable_spec_authoring.md
      - docs/spec/schema/schema_v1.md

  - id: CONFORMANCE_NO_AMBIENT_ASSUMPTIONS_GUARD
    introduced_in: v1
    scope: governance
    applies_to: fixtures.portable.ambient_assumptions
    norm: MUST
    requirement: reject_ambient_env_time_random_tokens_in_portable_case_content
    description: >
      Governance must reject portable conformance case content that includes
      ambient environment/time/random assumption tokens.
    rationale: Converts determinism guidance into an executable portability guardrail.
    risk_if_violated: Portable fixtures become host-dependent and parity drifts.
    references:
      - docs/spec/contract/06_conformance.md
      - docs/spec/contract/07_portable_spec_authoring.md
      - docs/spec/governance/cases/conformance_no_ambient_assumptions.spec.md

  - id: CONFORMANCE_PURPOSE_QUALITY_GATE
    introduced_in: v1
    scope: governance
    applies_to: fixtures.conformance.purpose_quality
    norm: MUST
    requirement: conformance_purpose_policy_and_cases_remain_within_warning_budget
    description: >
      Conformance purpose lint policy integrity and purpose text quality must
      satisfy governance warning budgets.
    rationale: Keeps fixture intent clear and avoids silent quality debt.
    risk_if_violated: Conformance cases lose clarity and increase review burden.
    references:
      - docs/spec/conformance/purpose_lint_v1.yaml
      - docs/spec/contract/06_conformance.md

  - id: DOCS_REF_SURFACE_COMPLETE
    introduced_in: v1
    scope: governance
    applies_to: docs.reference.surface
    norm: MUST
    requirement: required_reference_surface_files_exist
    description: >
      The canonical docs reference surface files must exist and remain present
      as an enforced product surface.
    rationale: Prevents accidental deletion/drift of required reference material.
    risk_if_violated: Missing reference pages break onboarding and contract lookup.
    references:
      - docs/spec/contract/10_docs_quality.md
      - docs/book/reference_index.md
      - docs/spec/schema/schema_v1.md

  - id: DOCS_REFERENCE_INDEX_SYNC
    introduced_in: v1
    scope: governance
    applies_to: docs.reference.index
    norm: MUST
    requirement: reference_index_matches_actual_book_chapter_set_and_order
    description: >
      The machine-checked reference index must stay synchronized with the actual
      reference-manual chapter files and ordering.
    rationale: Keeps the reference manual deterministic and reviewable.
    risk_if_violated: Index/doc drift causes broken navigation and stale guidance.
    references:
      - docs/spec/contract/10_docs_quality.md
      - docs/book/reference_index.md

  - id: DOCS_REQUIRED_SECTIONS_PRESENT
    introduced_in: v1
    scope: governance
    applies_to: docs.reference.sections
    norm: MUST
    requirement: required_section_tokens_present_in_reference_chapters
    description: >
      Required reference chapters must include required section tokens defined by
      governance policy.
    rationale: Maintains a consistent reference-manual structure.
    risk_if_violated: Critical usage/failure guidance disappears over time.
    references:
      - docs/spec/contract/10_docs_quality.md
      - docs/book/02_core_model.md
      - docs/book/03_assertions.md
      - docs/book/04_spec_lang_reference.md

  - id: DOCS_EXAMPLES_RUNNABLE_OR_EXPLICITLY_OPTED_OUT
    introduced_in: v1
    scope: governance
    applies_to: docs.reference.examples
    norm: MUST
    requirement: examples_parse_or_have_explicit_opt_out_marker_with_reason
    description: >
      Documentation examples must be parseable/runnable by default, or include
      an explicit and justified opt-out marker.
    rationale: Ensures examples are trustworthy for real users.
    risk_if_violated: Copy/paste examples fail and increase support load.
    references:
      - docs/spec/contract/10_docs_quality.md
      - docs/book/README.md

  - id: DOCS_CLI_FLAGS_DOCUMENTED
    introduced_in: v1
    scope: governance
    applies_to: docs.cli.flags
    norm: MUST
    requirement: public_runner_flags_documented_in_dev_and_impl_docs
    description: >
      Public runner CLI flags must be documented in required development and
      implementation docs.
    rationale: Keeps automation-facing interfaces discoverable and stable.
    risk_if_violated: Users guess flags and misuse runner commands.
    references:
      - docs/spec/contract/10_docs_quality.md
      - docs/development.md
      - docs/spec/impl/python.md
      - docs/spec/impl/php.md

  - id: DOCS_CONTRACT_SCHEMA_BOOK_TOKEN_SYNC
    introduced_in: v1
    scope: governance
    applies_to: docs.contract.schema.book.tokens
    norm: MUST
    requirement: core_assertion_tokens_synchronized_across_book_contract_schema
    description: >
      Core assertion token vocabulary must stay synchronized across reference
      book docs, contract docs, and schema docs.
    rationale: Prevents readers from seeing conflicting terminology.
    risk_if_violated: Authoring and implementation drift leads to false failures.
    references:
      - docs/spec/contract/10_docs_quality.md
      - docs/book/03_assertions.md
      - docs/spec/contract/03_assertions.md
      - docs/spec/schema/schema_v1.md

  - id: DOCS_MAKE_COMMANDS_SYNC
    introduced_in: v1
    scope: governance
    applies_to: docs.command.entrypoints
    norm: MUST
    requirement: key_docs_reference_canonical_make_command_entrypoints
    description: >
      Key contributor docs must reference canonical make command entrypoints
      used for docs verification and full gate execution.
    rationale: Reduces command drift and onboarding ambiguity.
    risk_if_violated: Contributors run stale commands and miss required checks.
    references:
      - README.md
      - docs/development.md

  - id: DOCS_ADOPTION_PROFILES_SYNC
    introduced_in: v1
    scope: governance
    applies_to: docs.adoption.profiles
    norm: MUST
    requirement: key_docs_define_and_sync_core_and_full_profiles
    description: >
      Key contributor docs must define core and full adoption profiles and
      keep their command entrypoints synchronized.
    rationale: Keeps onboarding clear for lightweight and full-gate workflows.
    risk_if_violated: Teams run inconsistent command lanes and miss expected checks.
    references:
      - docs/spec/contract/11_adoption_profiles.md
      - README.md
      - docs/development.md

  - id: RUNTIME_RUNNER_INTERFACE_GATE_SYNC
    introduced_in: v1
    scope: governance
    applies_to: runtime.gate_orchestration
    norm: SHOULD
    requirement: gate_scripts_call_runner_interface_boundary
    description: >
      Gate shell scripts should call a runner interface command boundary
      (`SPEC_RUNNER_BIN`) instead of hardcoding Python script entrypoints.
    rationale: Keeps orchestration portable across compliant runner implementations.
    risk_if_violated: Removing Python requires rewriting gate orchestration logic.
    references:
      - docs/spec/contract/12_runner_interface.md
      - scripts/runner_adapter.sh
      - scripts/ci_gate.sh
      - scripts/core_gate.sh
      - scripts/docs_doctor.sh

  - id: RUNTIME_ASSERTIONS_VIA_SPEC_LANG
    introduced_in: v1
    scope: implementation
    applies_to: runtime.assertion_execution
    norm: MUST
    requirement: compile_leaf_ops_to_spec_lang_predicates_before_execution
    description: >
      Runtime assertion paths must compile external leaf ops to spec-lang
      predicates and evaluate through the spec-lang engine, rather than direct
      ad-hoc operator execution branches.
    rationale: Preserves one semantic execution model across implementations.
    risk_if_violated: Cross-runner drift and hidden behavior inconsistencies.
    references:
      - docs/spec/contract/09_internal_representation.md
      - docs/spec/contract/03b_spec_lang_v1.md

  - id: CONTRACT_MUST_RULE_COVERAGE_COMPLETE
    introduced_in: v1
    scope: governance
    applies_to: docs.spec.contract.coverage
    norm: MUST
    requirement: all_must_rules_have_traceability_evidence
    description: >
      All active MUST contract rules must remain covered by traceability
      evidence (unit tests and/or conformance fixtures).
    rationale: Prevents normative MUST requirements from becoming unenforced.
    risk_if_violated: Contract claims can drift from executable guarantees.
    references:
      - docs/spec/contract/policy_v1.yaml
      - docs/spec/contract/traceability_v1.yaml
