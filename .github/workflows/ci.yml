name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  runner-contract:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install runtime deps
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-yaml jq curl ripgrep rustc cargo
          php -m | grep -i '^yaml$'

      - name: Install dc-runner
        run: |
          cargo install --git https://github.com/jonruttan/dc-runner-rust --rev 3ca5c87 dc-runner-cli --locked --force
          dc-runner --version

      - name: Emit governance catalog facts
        run: |
          mkdir -p .artifacts
          dc-runner governance run
          cp -f .artifacts/governance-summary.json .artifacts/governance-catalog-validate.json
          cp -f .artifacts/governance-trace.json .artifacts/governance-catalog-validate-trace.json
          cp -f .artifacts/governance-summary.md .artifacts/governance-catalog-validate.md

      - name: Emit schema pin facts
        run: |
          mkdir -p .artifacts
          dc-runner governance run
          cp -f .artifacts/governance-summary.json .artifacts/spec-schema-pin-validate.json
          cp -f .artifacts/governance-trace.json .artifacts/spec-schema-pin-validate-trace.json
          cp -f .artifacts/governance-summary.md .artifacts/spec-schema-pin-validate.md

      - name: Ingest runner status matrix facts
        run: |
          mkdir -p .artifacts
          dc-runner governance run
          cp -f .artifacts/governance-summary.json .artifacts/runner-status-matrix.json
          cp -f .artifacts/governance-summary.md .artifacts/runner-status-matrix.md
          cp -f .artifacts/governance-trace.json .artifacts/runner-status-ingest-log.json

      - name: Emit runner-contract pack artifact
        run: |
          jq -n --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '{generated_at:$generated_at, pack_manifest:"/specs/packs/runner_contract_pack_v1.yaml", status:"present"}' > .artifacts/spec-pack-runner-contract.json

      - name: Upload runner-contract artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runner-contract-artifacts
          path: |
            .artifacts/runner-status-matrix.json
            .artifacts/runner-status-matrix.md
            .artifacts/runner-status-ingest-log.json
            .artifacts/spec-pack-runner-contract.json
          if-no-files-found: warn

  spec-core:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - runner-contract

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dc-runner
        run: |
          cargo install --git https://github.com/jonruttan/dc-runner-rust --rev 3ca5c87 dc-runner-cli --locked --force
          dc-runner --version

      - name: Run governance
        run: dc-runner governance run

      - name: Emit spec-core pack artifact
        run: |
          jq -n --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '{generated_at:$generated_at, pack_manifest:"/specs/packs/spec_core_maintenance_pack_v1.yaml", status:"present"}' > .artifacts/spec-pack-spec-core.json

      - name: Upload spec-core artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spec-core-artifacts
          path: |
            .artifacts/governance-summary.json
            .artifacts/governance-trace.json
            .artifacts/governance-summary.md
            .artifacts/spec-pack-spec-core.json
          if-no-files-found: warn

  project-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - spec-core

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dc-runner
        run: |
          cargo install --git https://github.com/jonruttan/dc-runner-rust --rev 3ca5c87 dc-runner-cli --locked --force
          dc-runner --version

      - name: Run docs checks
        run: |
          dc-runner docs generate-check

      - name: Emit project-docs pack artifact
        run: |
          mkdir -p .artifacts
          jq -n --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '{generated_at:$generated_at, pack_manifest:"/specs/packs/project_docs_maintenance_pack_v1.yaml", status:"present"}' > .artifacts/spec-pack-project-docs.json

      - name: Upload project-docs artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: project-docs-artifacts
          path: |
            .artifacts/spec-pack-project-docs.json
          if-no-files-found: warn

  optional-report:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - project-docs
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dc-runner
        run: |
          cargo install --git https://github.com/jonruttan/dc-runner-rust --rev 3ca5c87 dc-runner-cli --locked --force
          dc-runner --version

      - name: Run optional governance report
        run: |
          mkdir -p .artifacts
          dc-runner governance broad || true
          cp -f .artifacts/governance-summary.json .artifacts/governance-optional-report.json 2>/dev/null || true
          cp -f .artifacts/governance-trace.json .artifacts/governance-optional-report-trace.json 2>/dev/null || true
          cp -f .artifacts/governance-summary.md .artifacts/governance-optional-report.md 2>/dev/null || true
          cp -f .artifacts/governance-optional-report.md .artifacts/governance-optional-summary.md 2>/dev/null || true

      - name: Upload optional artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: optional-report-artifacts
          path: |
            .artifacts/governance-optional-summary.md
            .artifacts/governance-optional-report.json
          if-no-files-found: warn
