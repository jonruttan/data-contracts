name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  runner-preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      required_version: ${{ steps.contract.outputs.required_version }}
      crate_name: ${{ steps.contract.outputs.crate_name }}
      binary_name: ${{ steps.contract.outputs.binary_name }}
      entrypoint_manifest: ${{ steps.contract.outputs.entrypoint_manifest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Read runner version contract
        id: contract
        run: |
          set -euo pipefail
          contract="specs/00_core/runner_version_contract_v1.yaml"
          crate_name="$(awk -F': *' '/^[[:space:]]+crate:/{print $2; exit}' "$contract" | tr -d '"')"
          binary_name="$(awk -F': *' '/^[[:space:]]+binary:/{print $2; exit}' "$contract" | tr -d '"')"
          required_version="$(awk -F': *' '/^required_version:/{print $2; exit}' "$contract" | tr -d '"')"
          entrypoint_manifest="$(awk -F': *' '/^entrypoint_manifest:/{print $2; exit}' "$contract" | tr -d '"')"
          unpublished_policy="$(awk -F': *' '/^[[:space:]]+on_unpublished_version:/{print $2; exit}' "$contract" | tr -d '"')"

          if [ -z "$crate_name" ] || [ -z "$binary_name" ] || [ -z "$required_version" ] || [ -z "$entrypoint_manifest" ]; then
            echo "ERROR: invalid runner version contract: $contract"
            exit 1
          fi

          if [ "$unpublished_policy" != "hard_fail" ]; then
            echo "ERROR: unsupported on_unpublished_version policy '$unpublished_policy'"
            exit 1
          fi

          if [ ! -f ".${entrypoint_manifest}" ]; then
            echo "ERROR: entrypoint manifest from contract not found: ${entrypoint_manifest}"
            exit 1
          fi

          echo "crate_name=$crate_name" >> "$GITHUB_OUTPUT"
          echo "binary_name=$binary_name" >> "$GITHUB_OUTPUT"
          echo "required_version=$required_version" >> "$GITHUB_OUTPUT"
          echo "entrypoint_manifest=$entrypoint_manifest" >> "$GITHUB_OUTPUT"

      - name: Install required dc-runner version
        run: |
          set -euo pipefail
          cargo install "${{ steps.contract.outputs.crate_name }}" --locked --version "${{ steps.contract.outputs.required_version }}" --force
          "${{ steps.contract.outputs.binary_name }}" --version

      - name: Verify runner entrypoint compatibility
        run: |
          set -euo pipefail
          manifest=".${{ steps.contract.outputs.entrypoint_manifest }}"
          runner_bin="${{ steps.contract.outputs.binary_name }}"
          mkdir -p .artifacts
          out=".artifacts/runner-entrypoints.json"

          "${runner_bin}" entrypoints list --format json > "$out"
          expected_ids="$(sed -n 's/^  - id: //p' "$manifest")"
          if [ -z "$expected_ids" ]; then
            echo "ERROR: no expected entrypoint IDs found in $manifest"
            exit 1
          fi

          missing=0
          while IFS= read -r id; do
            [ -z "$id" ] && continue
            if ! grep -q "\"id\": \"${id}\"" "$out"; then
              echo "ERROR: installed ${runner_bin} missing required entrypoint id: ${id}"
              missing=1
            fi
          done <<EOF_IDS
          ${expected_ids}
          EOF_IDS

          if [ "$missing" -ne 0 ]; then
            echo "ERROR: installed ${runner_bin} is not compatible with current specs. Publish/update dc-runner-cli before running this CI."
            exit 1
          fi

  bundle-preflight:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - runner-preflight

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify pinned canonical bundles
        run: |
          set -euo pipefail
          contract="specs/00_core/bundle_version_contract_v1.yaml"
          if [ ! -f "$contract" ]; then
            echo "ERROR: bundle version contract not found: $contract"
            exit 1
          fi

          repo="$(awk -F': *' '/^[[:space:]]+repo:/{print $2; exit}' "$contract" | tr -d '"')"
          policy="$(awk -F': *' '/^[[:space:]]+on_unpublished_version:/{print $2; exit}' "$contract" | tr -d '"')"
          if [ "$repo" != "jonruttan/data-contracts-bundles" ]; then
            echo "ERROR: source.repo must be jonruttan/data-contracts-bundles"
            exit 1
          fi
          if [ "$policy" != "hard_fail" ]; then
            echo "ERROR: policy.on_unpublished_version must be hard_fail"
            exit 1
          fi

          records="$(awk '
          /^[[:space:]]*-[[:space:]]bundle_id:[[:space:]]*/ {
            line=$0
            sub(/^[[:space:]]*-[[:space:]]bundle_id:[[:space:]]*/, "", line)
            gsub(/"/, "", line)
            id=line
          }
          /^[[:space:]]*bundle_version:[[:space:]]*/ {
            line=$0
            sub(/^[[:space:]]*bundle_version:[[:space:]]*/, "", line)
            gsub(/"/, "", line)
            ver=line
          }
          /^[[:space:]]*required_payload_files:[[:space:]]*\[/ {
            payload=$0
            sub(/.*\[/, "", payload)
            sub(/\].*/, "", payload)
            gsub(/[[:space:]\"]/, "", payload)
            if (id != "" && ver != "") {
              print id "|" ver "|" payload
              id=""; ver=""; payload=""
            }
          }
          ' "$contract")"
          if [ -z "$records" ]; then
            echo "ERROR: no required bundle records parsed from $contract"
            exit 1
          fi

          tmpdir="$(mktemp -d)"
          trap 'rm -rf "$tmpdir"' EXIT
          while IFS='|' read -r bundle_id bundle_version payload_csv; do
            [ -z "$bundle_id" ] && continue
            if ! [[ "$bundle_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+([-.+][A-Za-z0-9.-]+)?$ ]]; then
              echo "ERROR: bundle_version must be semver for $bundle_id (got: $bundle_version)"
              exit 1
            fi

            tag="v${bundle_version}"
            asset="data-contract-bundle-${bundle_id}-v${bundle_version}.tar.gz"
            sidecar="${asset}.sha256"
            base_url="https://github.com/${repo}/releases/download/${tag}"
            tar_path="${tmpdir}/${asset}"
            sha_path="${tmpdir}/${sidecar}"

            echo "verify bundle ${bundle_id}@${bundle_version}"
            curl --fail --location --silent --show-error "${base_url}/${asset}" --output "$tar_path" || {
              echo "ERROR: missing release asset ${asset}; publish required bundle version"
              exit 1
            }
            curl --fail --location --silent --show-error "${base_url}/${sidecar}" --output "$sha_path" || {
              echo "ERROR: missing release sidecar ${sidecar}; publish required bundle version"
              exit 1
            }
            expected="$(awk '{print $1; exit}' "$sha_path")"
            actual="$(shasum -a 256 "$tar_path" | awk '{print $1}')"
            if [ "$expected" != "$actual" ]; then
              echo "ERROR: checksum mismatch for ${asset}"
              exit 1
            fi

            list_path="${tmpdir}/${bundle_id}.list"
            tar -tzf "$tar_path" > "$list_path"
            IFS=',' read -r -a payloads <<< "$payload_csv"
            for payload in "${payloads[@]}"; do
              [ -z "$payload" ] && continue
              if ! grep -Eq "(^|\\./)${payload}$" "$list_path"; then
                echo "ERROR: payload file ${payload} missing in ${asset}"
                exit 1
              fi
            done
          done <<< "$records"

  runner-contract:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - runner-preflight
      - bundle-preflight

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install runtime deps
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-yaml jq curl ripgrep
          php -m | grep -i '^yaml$'

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dc-runner
        run: |
          cargo install "${{ needs.runner-preflight.outputs.crate_name }}" --locked --version "${{ needs.runner-preflight.outputs.required_version }}" --force
          "${{ needs.runner-preflight.outputs.binary_name }}" --version

      - name: Emit governance catalog facts
        run: |
          mkdir -p .artifacts
          dc-runner governance run
          cp -f .artifacts/governance-summary.json .artifacts/governance-catalog-validate.json
          cp -f .artifacts/governance-trace.json .artifacts/governance-catalog-validate-trace.json
          cp -f .artifacts/governance-summary.md .artifacts/governance-catalog-validate.md

      - name: Emit schema pin facts
        run: |
          mkdir -p .artifacts
          dc-runner governance run
          cp -f .artifacts/governance-summary.json .artifacts/spec-schema-pin-validate.json
          cp -f .artifacts/governance-trace.json .artifacts/spec-schema-pin-validate-trace.json
          cp -f .artifacts/governance-summary.md .artifacts/spec-schema-pin-validate.md

      - name: Ingest runner status matrix facts
        run: |
          mkdir -p .artifacts
          dc-runner governance run
          cp -f .artifacts/governance-summary.json .artifacts/runner-status-matrix.json
          cp -f .artifacts/governance-summary.md .artifacts/runner-status-matrix.md
          cp -f .artifacts/governance-trace.json .artifacts/runner-status-ingest-log.json

      - name: Emit runner-contract pack artifact
        run: |
          jq -n --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '{generated_at:$generated_at, pack_manifest:"/specs/packs/runner_contract_pack_v1.yaml", status:"present"}' > .artifacts/spec-pack-runner-contract.json

      - name: Upload runner-contract artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runner-contract-artifacts
          path: |
            .artifacts/runner-status-matrix.json
            .artifacts/runner-status-matrix.md
            .artifacts/runner-status-ingest-log.json
            .artifacts/spec-pack-runner-contract.json
          if-no-files-found: warn

  spec-core:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - runner-preflight
      - runner-contract

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dc-runner
        run: |
          cargo install "${{ needs.runner-preflight.outputs.crate_name }}" --locked --version "${{ needs.runner-preflight.outputs.required_version }}" --force
          "${{ needs.runner-preflight.outputs.binary_name }}" --version

      - name: Run governance
        run: dc-runner governance run

      - name: Emit spec-core pack artifact
        run: |
          jq -n --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '{generated_at:$generated_at, pack_manifest:"/specs/packs/spec_core_maintenance_pack_v1.yaml", status:"present"}' > .artifacts/spec-pack-spec-core.json

      - name: Upload spec-core artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spec-core-artifacts
          path: |
            .artifacts/governance-summary.json
            .artifacts/governance-trace.json
            .artifacts/governance-summary.md
            .artifacts/spec-pack-spec-core.json
          if-no-files-found: warn

  project-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - runner-preflight
      - spec-core

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dc-runner
        run: |
          cargo install "${{ needs.runner-preflight.outputs.crate_name }}" --locked --version "${{ needs.runner-preflight.outputs.required_version }}" --force
          "${{ needs.runner-preflight.outputs.binary_name }}" --version

      - name: Run docs checks
        run: |
          dc-runner docs generate-check

      - name: Emit project-docs pack artifact
        run: |
          mkdir -p .artifacts
          jq -n --arg generated_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" '{generated_at:$generated_at, pack_manifest:"/specs/packs/project_docs_maintenance_pack_v1.yaml", status:"present"}' > .artifacts/spec-pack-project-docs.json

      - name: Upload project-docs artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: project-docs-artifacts
          path: |
            .artifacts/spec-pack-project-docs.json
          if-no-files-found: warn

  optional-report:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - runner-preflight
      - project-docs
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dc-runner
        run: |
          cargo install "${{ needs.runner-preflight.outputs.crate_name }}" --locked --version "${{ needs.runner-preflight.outputs.required_version }}" --force
          "${{ needs.runner-preflight.outputs.binary_name }}" --version

      - name: Run optional governance report
        run: |
          mkdir -p .artifacts
          dc-runner governance broad || true
          cp -f .artifacts/governance-summary.json .artifacts/governance-optional-report.json 2>/dev/null || true
          cp -f .artifacts/governance-trace.json .artifacts/governance-optional-report-trace.json 2>/dev/null || true
          cp -f .artifacts/governance-summary.md .artifacts/governance-optional-report.md 2>/dev/null || true
          cp -f .artifacts/governance-optional-report.md .artifacts/governance-optional-summary.md 2>/dev/null || true

      - name: Upload optional artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: optional-report-artifacts
          path: |
            .artifacts/governance-optional-summary.md
            .artifacts/governance-optional-report.json
          if-no-files-found: warn
