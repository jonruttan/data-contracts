name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  local-status-exchange:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ingest deps
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-yaml jq curl
          php -m | grep -i '^yaml$'

      - name: Run deterministic local status exchange scenarios
        run: ./scripts/local_status_exchange_test.sh

      - name: Upload local status exchange artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: local-status-exchange-artifacts
          path: .artifacts/**
          if-no-files-found: ignore

  runner-status-ingest:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PHP + yaml extension
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-yaml jq curl
          php -m | grep -i '^yaml$'

      - name: Ingest runner status matrix (freshness enforced)
        run: ./scripts/runner_status_ingest.sh --max-age-hours 72 --enforce-freshness

      - name: Upload runner status artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runner-status-artifacts
          path: |
            .artifacts/runner-status-matrix.json
            .artifacts/runner-status-matrix.md
            .artifacts/runner-status-ingest-log.json
          if-no-files-found: warn

  control-plane-governance:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - runner-status-ingest
      - local-status-exchange

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq ripgrep

      - name: Run control-plane governance checks
        run: ./scripts/control_plane.sh governance

      - name: Run docs reference checks
        run: ./scripts/control_plane.sh docs-generate-check
      - name: Run optional governance report (non-blocking)
        run: python3 ./scripts/governance_optional_report.py || true


      - name: Upload governance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: control-plane-governance-artifacts
          path: .artifacts/**
          if-no-files-found: ignore

  ci-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      - runner-status-ingest
      - control-plane-governance

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install runtime deps
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-yaml jq curl ripgrep

      - name: Run control-plane CI gate
        run: ./scripts/ci_gate.sh

      - name: Upload gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts
          path: .artifacts/**
          if-no-files-found: ignore
