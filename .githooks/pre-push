#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "${ROOT_DIR}"

if [[ "${SPEC_PREPUSH_BYPASS:-0}" == "1" ]]; then
  echo "[pre-push] WARNING: bypass enabled via SPEC_PREPUSH_BYPASS=1" >&2
  exit 0
fi

if [[ "${CI:-}" == "true" ]]; then
  exit 0
fi

collect_changed_paths() {
  local upstream=""
  local lines=()
  if upstream="$(git rev-parse --abbrev-ref --symbolic-full-name '@{upstream}' 2>/dev/null)"; then
    while IFS= read -r line; do
      [[ -n "${line}" ]] && lines+=("${line}")
    done < <(git diff --name-only "${upstream}...HEAD")
  fi
  while IFS= read -r line; do
    [[ -n "${line}" ]] && lines+=("${line}")
  done < <(git diff --name-only)
  while IFS= read -r line; do
    [[ -n "${line}" ]] && lines+=("${line}")
  done < <(git diff --name-only --cached)
  while IFS= read -r line; do
    [[ -n "${line}" ]] && lines+=("${line}")
  done < <(git ls-files --others --exclude-standard)
  if [[ "${#lines[@]}" -eq 0 ]]; then
    return 0
  fi
  printf '%s\n' "${lines[@]}" | awk '!seen[$0]++'
}

is_check_sets_only_change() {
  local changed path
  changed="$(collect_changed_paths || true)"
  [[ -n "${changed}" ]] || return 1
  while IFS= read -r path; do
    [[ -z "${path}" ]] && continue
    if [[ "${path}" != "specs/governance/check_sets_v1.yaml" ]]; then
      return 1
    fi
  done <<< "${changed}"
  return 0
}

is_gate_script_only_change() {
  local changed path
  changed="$(collect_changed_paths || true)"
  [[ -n "${changed}" ]] || return 1
  while IFS= read -r path; do
    [[ -z "${path}" ]] && continue
    if [[ "${path}" != "scripts/local_ci_parity.sh" && "${path}" != "scripts/ci_gate.sh" ]]; then
      return 1
    fi
  done <<< "${changed}"
  return 0
}

if is_check_sets_only_change; then
  echo "[pre-push] fast path: check_sets-only change"
  exec SPEC_PREPUSH_MODE=critical ./scripts/local_ci_parity.sh
fi

if is_gate_script_only_change; then
  echo "[pre-push] fast path: gate-script-only change"
  exec SPEC_PREPUSH_MODE=critical ./scripts/local_ci_parity.sh
fi

echo "[pre-push] running local CI parity gate"
exec make prepush
